{"version":3,"file":"Shap.umd.min.js","sources":["../src/utils/index.ts","../src/vdom/create-element.ts","../src/vdom/h.ts","../src/utils/Api.ts","../src/views/suspension.ts","../src/vdom/vnode.ts","../src/utils/Vue.ts","../src/vdom/patch.ts","../src/shap.ts","../src/vm.ts","../src/common/plugin.ts","../src/common/attend.ts"],"sourcesContent":["const querySelector = document.querySelector.bind(document)\nconst { toString } = Object.prototype\n\nexport const $ = (selector: string | HTMLElement): HTMLElement => {\n  return selector instanceof HTMLElement ? selector : querySelector(selector)\n}\n\nexport const isType = (obj: object, types: string | Array<string> = ''): boolean => {\n  const type = toString.call(obj).slice(8, -1).toLowerCase()\n  return Array.isArray(types)\n    ? types.map(t => t.toLowerCase()).includes(type)\n    : types.toLowerCase() === type\n}\n\nexport const clone = (obj: object) => JSON.parse(JSON.stringify(obj))\n\nexport const noop = function () {}\n\nexport function castArray <T> (value: T): Array<T> {\n  return value == null ? [] : Array.isArray(value) ? value : [value]\n}\n","import VNode from './vnode'\n\nconst createElementNode = document.createElement.bind(document)\nconst createTextNode = document.createTextNode.bind(document)\n\ninterface VNodeProps {\n  class: object\n  on: object\n  style: object\n}\n\ninterface Patch {\n  tag: string\n  props: VNodeProps\n  children: any\n}\n\nexport default function createElement ({ tag, props, children }: Patch, ctx: any) {\n  const { class: classProps, on: eventsProps, style: styleProps } = props\n  const className = tag.replace(/(^[^.]+)|(#.+)/g, '').slice(1).replace(/\\./g, ' ')\n  const el = createElementNode(tag.replace(/(\\.|#).+/g, ''))\n  if (className) el.className = className\n  for (let className in classProps) {\n    if (classProps[className]) el.classList.add(className)\n  }\n  for (let style in styleProps) el.style[style] = styleProps[style]\n  for (let event in eventsProps) el.addEventListener(event, (e: MouseEvent) => eventsProps[event].call(ctx, e))\n  children.forEach((child: Patch) => {\n    const node = child instanceof VNode ? createElement(child, ctx) : createTextNode(child)\n    el.appendChild(node)\n  })\n  return el\n}\n\nexport function createCommentNode () {\n  return document.createComment('')\n}\n","import { castArray, isType } from '../utils/'\nimport VNode from './vnode'\n\nexport default function createElement (tag: string, props: object, children: any) {\n  return children == null && isType(props, ['string', 'array'])\n    ? new VNode(tag, undefined, castArray(props))\n    : new VNode(tag, props, castArray(children))\n}\n","interface ApiConfig {\n  key: string\n  dev?: boolean\n  version?: string\n  appId?: string\n}\n\nexport default class Api {\n  static baas = ['_id', 'createdAt', 'updatedAt']\n\n  static filterBaaSKeywords (params: any) {\n    if (!params) return params\n    for (let keyword of Api.baas) params[keyword] = undefined\n    return params\n  }\n\n  private _key: string\n  private _plugins: Array<Function>\n\n  constructor (private _config: ApiConfig) {\n    this._key = _config.key\n    this._plugins = []\n  }\n\n  handleBaaSPayload (data: any): string {\n    const { _plugins: plugins, _key: key } = this\n    const body = Object.assign({}, Api.filterBaaSKeywords(data), { key })\n    for (let plugin of plugins) { Object.assign(body, plugin(body) || {}) }\n    return JSON.stringify(body)\n  }\n\n  mosaicRequestURL (tableName: string): string {\n    const { dev = false } = this._config\n    const url = dev ? 'ssr.alpha.elenet.me/shap-api' : 'ssr.ele.me/shap-api'\n    return `https://${url}/${tableName}`\n  }\n\n  request (method: string = 'post', tableName: string, data: object = {}): Promise<any> {\n    const mosaicRequestURL = this.mosaicRequestURL.bind(this, tableName)\n    const lowerCaseMethodName = method.toLowerCase()\n\n    const url = lowerCaseMethodName === 'get'\n      ? mosaicRequestURL(undefined, data)\n      : mosaicRequestURL()\n\n    return fetch(url, {\n      headers: new Headers({ 'content-type': 'application/json' }),\n      method: lowerCaseMethodName.toUpperCase(),\n      body: lowerCaseMethodName === 'get' ? null : this.handleBaaSPayload(data)\n    }).then(response => response.json())\n  }\n\n  plugin (cb: Function) {\n    this._plugins.push(cb)\n  }\n}\n\n['patch', 'post', 'get', 'delete'].forEach(method => {\n  Api.prototype[method] = function (...args: any[]) { return this.request(method, ...args) }\n})\n","export default function (h: any) {\n  const shapFeedbackButton = (vote: number) => {\n    return {\n      class: { 'sp__button': true },\n      on: {\n        click: this.sendDocFeedback.bind(this, vote),\n        mouseenter: () => { this.deviation = `${vote ? '-' : ''}` }\n      }\n    }\n  }\n\n  const content = [\n    h('header.sp__header', { on: { click: this.toggleFeedbackPanel } }, [\n      h('i.iconfont.icon-talk'),\n      h('span', this.leadin)\n    ]),\n    h('div.sp__body', [\n      h('button', shapFeedbackButton(5), [\n        h('i.iconfont.icon-smile')\n      ]),\n      h('button', shapFeedbackButton(0), [\n        h('i.iconfont.icon-sad')\n      ]),\n      h('div.sp__feedback', {\n        style: {\n          transform: `translateX(${this.deviation}30%)`\n        }\n      }, this.feedback)\n    ])\n  ]\n\n  return h('section.sp__container--suspension', {\n    class: {\n      'sp__container--feedback': this.voted,\n      'sp__container--full': this.spreading\n    }\n  }, content)\n}\n","interface VNodeClass {\n  [id: string]: string\n}\n\ninterface VNodeEvents {\n  [id: string]: (...args: any[]) => any\n}\n\ninterface VNodeProps {\n  class?: VNodeClass\n  on?: VNodeEvents\n}\n\nexport default class VNode {\n  public tag: string\n  public props?: VNodeProps\n  public children?: Array<VNode>\n\n  constructor (tag = 'div', props = {}, children = []) {\n    this.tag = tag\n    this.props = props\n    this.children = children\n  }\n}\n","import createElement, { createCommentNode } from '../vdom/create-element'\nimport { $, clone, noop } from './'\nimport patch from '../vdom/patch'\nimport h from '../vdom/h'\n\ninterface VueInstanceLifeHooks {\n  created (): any\n}\n\ninterface VueOptions {\n  el: string | HTMLElement\n  data?: any\n  methods?: any\n  render (h: any): any\n  [index: string]: any\n}\n\nexport default class Vue {\n  public $el: HTMLElement\n  public $options: VueInstanceLifeHooks\n  private _data: any\n  private _vnode: any\n  private _uid: number\n  private _render (h: any): any {}\n\n  static _ = {}\n\n  constructor (options: VueOptions) {\n    const { el = '', data = {}, methods = {}, render, created = noop } = options\n\n    Vue._ = clone(data)\n\n    this._data = data\n    this.$el = $(el)\n    this._render = render\n    this.$options = { created }\n\n    for (let event in methods) this[event] = methods[event].bind(this)\n\n    this.observe()\n    this.render()\n  }\n\n  public observe () {\n    const { _data: data } = this\n\n    for (let key in data) {\n      Object.defineProperty(this, key, {\n        get () { return data[key] },\n        set: val => {\n          data[key] = val\n          this.patch()\n        }\n      })\n    }\n  }\n\n  public patch () {\n    const vnode = this._render(h)\n    patch(this._vnode, vnode, this.$el)\n    this._vnode = vnode\n  }\n\n  public render () {\n    const vnode = this._render(h)\n    const element = !vnode ? createCommentNode() : createElement(vnode, this)\n    const { $el } = this\n    document.body.replaceChild(element, $el)\n    this.$el = element\n    this._vnode = vnode\n\n    if (vnode) {\n      const cloned = clone(Vue._)\n      for (let key in cloned) this[key] = cloned[key]\n      this.$options.created.call(this)\n    }\n  }\n}\n","interface VNodeProps {\n  class: object\n  on: object\n  style: object\n}\n\ninterface VNode {\n  props: VNodeProps\n}\n\nexport default function patch (prevNode: VNode, nextNode: VNode, el: HTMLElement) {\n  const { props: { class: nextNodeClass } } = nextNode\n  const { props: { class: prevNodeClass } } = prevNode\n\n  for (let className in nextNodeClass) {\n    const value = nextNodeClass[className]\n    if (prevNodeClass[className] !== value) {\n      el.classList[value ? 'add' : 'remove'](className)\n    }\n  }\n}\n","import Api from './utils/Api'\nimport './styles/app.css'\nimport vm from './vm'\n\ninterface ShapOptions {\n  key: string\n  el: string | HTMLElement\n  dev?: boolean\n  mode?: string\n  hash?: boolean\n  formatter?: () => string\n  absence?: () => boolean | RegExp\n}\n\nexport default class Shap {\n  private _vm: any\n  private _key: string\n  private _dev: boolean\n\n  constructor (private _options: ShapOptions) {\n    this._key = _options.key\n    this._dev = _options.dev || false\n    this.render()\n  }\n\n  public render () {\n    const { _key: key, _dev: dev, _options: options } = this\n    const { el = '.shap-container' } = options\n    const api = new Api({ key, dev })\n    this._vm = vm({ el, api, options })\n  }\n\n  public spa () {\n    const { _vm: vm } = this\n    setTimeout(vm.render.bind(vm), 4)\n  }\n}\n","import suspension from './views/suspension'\nimport plugin from './common/plugin'\nimport attend from './common/attend'\nimport { noop } from './utils/'\nimport Vue from './utils/Vue'\n\ninterface ShapConfig {\n  mode?: string\n  formatter?: () => string\n  feedback?: string\n  leadin?: string\n  hash?: boolean\n  absence?: () => boolean | RegExp\n}\n\ninterface VmOptions {\n  el: string | HTMLElement\n  options: ShapConfig\n  api: any\n}\n\nexport default function ({ el, api, options }: VmOptions) {\n  const { mode, formatter, hash = false, leadin, feedback, absence } = options\n\n  api.plugin(plugin.bind(null, formatter, hash))\n\n  return new Vue({\n    el,\n\n    data: {\n      deviation: '',\n      spreading: false,\n      voted: false,\n\n      previewScore: 0,\n      score: 0,\n      tooltip: {\n        visible: false,\n        left: 0\n      },\n\n      mode: mode || 'inline',\n      leadin: leadin || '这个页面有帮助吗？',\n      feedback: feedback || '感谢您的反馈！'\n    },\n\n    methods: {\n      toggleFeedbackPanel () {\n        this.spreading = !this.spreading\n      },\n\n      sendDocFeedback (vote: number) {\n        api.post('doc', { vote })\n          .then(() => {\n            this.voted = true\n            setTimeout(() => { this.spreading = false }, 1000)\n          }, noop)\n      }\n    },\n\n    render (h: any): any {\n      if (absence != null && attend(absence)) return\n      return suspension.call(this, h)\n    },\n\n    created () {\n      api.post('pv').then(noop, noop)\n    }\n  })\n}\n","export default (formatter: () => boolean, hash: boolean) => {\n  const path = formatter ? formatter() : (hash ? window.location.hash : window.location.pathname)\n  return { path, title: document.title }\n}\n","import { isType } from '../utils/'\n\nexport default (absence: any): boolean => {\n  return absence instanceof RegExp\n    ? absence.test(window.location.href.replace(window.location.origin, ''))\n    : (isType(absence, 'Function') ? absence() : undefined)\n}\n"],"names":["value","Array","isArray","_a","ctx","tag","props","children","classProps","eventsProps","styleProps","className","replace","slice","el","createElementNode","className_1","classList","add","style","event","addEventListener","e","call","forEach","child","node","VNode","createElement","createTextNode","appendChild","isType","undefined","castArray","_config","this","_key","key","_plugins","Api","params","baas","_i","data","plugins","body","Object","assign","filterBaaSKeywords","plugins_1","plugin","JSON","stringify","tableName","method","mosaicRequestURL","bind","lowerCaseMethodName","toLowerCase","url","fetch","headers","Headers","content-type","toUpperCase","handleBaaSPayload","then","response","json","cb","push","prototype","args","request","querySelector","document","toString","$","selector","HTMLElement","obj","types","type","map","t","includes","clone","parse","noop","options","_b","_c","methods","render","_d","created","Vue","_","_data","$el","_render","$options","observe","h","defineProperty","get","set","val","_this","patch","vnode","prevNode","nextNode","nextNodeClass","prevNodeClass","_vnode","element","createComment","replaceChild","cloned","_options","_dev","dev","Shap","api","_vm","mode","formatter","hash","leadin","feedback","absence","path","window","location","pathname","title","deviation","spreading","voted","previewScore","score","tooltip","visible","left","toggleFeedbackPanel","sendDocFeedback","vote","post","setTimeout","RegExp","test","href","origin","attend","shapFeedbackButton","class","sp__button","on","click","mouseenter","content","transform","sp__container--feedback","sp__container--full","vm"],"mappings":"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"}